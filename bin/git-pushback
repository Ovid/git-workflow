#!/usr/bin/env bash

# vim: filetype=sh

function show_help() {
    less <<END
$(basename "$0")

    -? -h --help Show this help and exit
    -force Force the push via --force-with-lease

Attempts to push this branch back to origin with the current branch name. You
can only use 'git pushback' a branch that is not your target branch (see
CONFIG FILE below)

This project is on github at https://github.com/Ovid/git-workflow
END
}

POSITIONAL=()
force=
while [[ $# -gt 0 ]]
do
key="$1"
case $key in
    -f|--force)
    shift # past argument
    force=1;
    ;;
    -?|-h|--help)
    shift # past argument
    show_help;
    exit;
    ;;
esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters

set -Eeuo pipefail

target=$(basename $( git symbolic-ref refs/remotes/origin/HEAD ) )
if [ -z $target ]; then
    echo Could not determine target branch via '"basename $( git symbolic-ref refs/remotes/origin/HEAD )"'
    exit 1
fi

if [ "$branch" == "$target" ]; then
    echo ERROR: You must checkout the branch to be merged or supply branch as argument
    exit 1
fi

if [ "$branch" == "$target" ]; then
    echo You cannot pushback $target. You must be on a branch.
    exit 1
else
    if [ -z "$force" ]; then
        git push --set-upstream origin $branch
    else
        git push --force-with-lease --set-upstream origin $branch
    fi
fi
